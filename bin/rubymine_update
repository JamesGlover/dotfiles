#!/usr/bin/env ruby
require 'rubygems'
require 'rake'

body = `curl --silent http://www.jetbrains.com/ruby/download/download_thanks.jsp?os=linux | grep .tar.gz`
url = body.match(%r{http://.*?\.tar\.gz})[0]
puts url

archive = "/opt/rubymine.#{Time.now.strftime("%Y-%m-%d_%H:%M:%S")}"
install_dir = "/opt/rubymine"
unpacked = File.basename(url).sub('.tar.gz','').sub('_','-')

sh "cd /tmp && rm -rf RubyMine*"
sh "wget #{url} && tar xfz #{File.basename(url)}"
sh "sudo mv #{install_dir} #{archive}" if File.exist?(install_dir)
sh "sudo mv #{unpacked} #{install_dir}"

# make multi-clipboard work for Ubuntu
sh "echo 'idea.use.alt.clipboard.sync=true' >> /opt/rubymine/bin/idea.properties"
